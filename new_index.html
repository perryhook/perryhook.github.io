<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://d3js.org/d3.v5.min.js"></script>

<body onload='init()'>
<div class="nav">
  <button class="btn" onclick="reset()">« Reset</button>
  <!-- remove the gap -->
  <button class="btn next_btn" onclick="next()">Next »</button>
</div>
<svg width=950 height=500></svg>

<script>
var state = null;
async function init() {
  const data = await d3.csv("overview_data.csv");
  // format the data
  var parseTime = d3.timeParse("%m/%d/%Y");
  data.forEach(function(d) {
      d.date = parseTime(d.date);
      d.composite_price = parseFloat(d.composite_price);
      d.stockpile = parseFloat(d.stockpile);
  });
  var flt_stock_data = data.filter(function(d) { return !isNaN(d.stockpile) });
  //console.log(JSON.stringify(flt_stock_data, null, 2));

  var margin = {top: 100, right: 100, bottom: 50, left: 50}
    , width = window.innerWidth - margin.left - margin.right
    , height = window.innerHeight - margin.top - margin.bottom - 100;

  var x = d3.scaleTime().range([0, width]).domain(d3.extent(data, function(d) { return d.date; }));
  y0_domain = d3.extent(data, data => data.composite_price);
  y0_domain[0] = y0_domain[0] - (0.1 * (y0_domain[1] - y0_domain[0]));
  var y0 = d3.scaleLinear().range([height, 0]).domain(y0_domain);
  y1_domain = d3.extent(flt_stock_data, flt_stock_data => flt_stock_data.stockpile);
  y1_domain[0] = y1_domain[0] - (0.1 * (y1_domain[1] - y1_domain[0]));
  var y1 = d3.scaleLinear().range([height, 0]).domain(y1_domain);

  // price line
  var priceline = d3.line()
      .x(function(d) { return x(d.date); })
      .y(function(d) { return y0(d.composite_price); });

  // stockpile line
  var stockline = d3.line()
      .defined(function(d) { return d.stockpile > 0; })
      .x(function(d) { return x(d.date); })
      .y(function(d) { return y1(d.stockpile); });

  var svg = d3.select("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  // add the priceline path
  svg.append("path")
      .data([data])
      .attr("class", "line")
      .attr("id", "priceline")
      .attr("d", priceline);

  // add the stockpile path
  svg.append("path")
      .data([flt_stock_data])
      .attr("class", "line")
      .attr("id", "stockline")
      .attr("d", stockline);

  // add the x axis
  svg.append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).ticks(d3.timeYear));

  // add the y0 axis
  svg.append("g")
      .attr("id", "priceline_axis")
      .call(d3.axisLeft(y0).tickFormat(d3.format('$,.2f')));

  svg.append("text")
    .attr("class", "axis_label")
    .attr("transform", "rotate(-90)")
    .attr("x", -200)
    .attr("y", 6)
    .attr("dy", "0.71em")
    .text("ICO Composite Price (USD/Pound)");

  // add the y1 axis
  svg.append("g")
     .attr("class", "right_axis")
     .attr("id", "stockline_axis")
     .attr("transform", "translate( " + width + ", 0 )")
     .call(d3.axisRight(y1));

  svg.append("text")
     .attr("class", "axis_label right_axis")
     .attr("id", "stockline_axis_label")
     .attr("transform", "rotate(-90)")
     .attr("x", -100)
     .attr("y", width - 15)
     .attr("dy", "0.71em")
     .text("1000 60kg Bags");
  d3.select("#stockline_axis,#stockline_axis_label").style("opacity", "0");

  d3.selectAll(".line")
    .on("mouseover", function() {
      console.log("in mouseover");
      d3.select(this).transition().duration("10")
        .style("opacity", "0.5")
        .style("stroke-width", "6");})
    .on("mouseout", function() {
      console.log("in mouseout");
      d3.select(this).transition().duration("10")
        .style("opacity", "1")
        .style("stroke-width", "3");});


  animatelines();
}

function animatelines() {
  console.log("animatelines called with state: " + state);

    if(state === null) {
      d3.selectAll(".line,.right_axis").style("opacity", "0");
      d3.select("#priceline").style("opacity", "1").style("stroke-width", 6);
      var totalLength = d3.select("#priceline").node().getTotalLength();
      d3.selectAll("#priceline")
        .attr("stroke-dasharray", totalLength + " " + totalLength)
        .attr("stroke-dashoffset", totalLength)
        .transition("drawPriceLine")
        .duration(3000)
        .ease(d3.easeLinear)
        .attr("stroke-dashoffset", 0);
      state = 0;
    } else if (state == 0) {
      d3.select("#stockline_axis_label,#stockline_axis").style("opacity", "0");
      var totalLength = d3.select("#stockline").node().getTotalLength();
      d3.select("#stockline").style("opacity", "1").style("stroke-width", 6);
      d3.select("#stockline")
        .attr("stroke-dasharray", totalLength + " " + totalLength)
        .attr("stroke-dashoffset", totalLength)
        .transition("drawStockLine")
        .duration(3000)
        .ease(d3.easeLinear)
        .attr("stroke-dashoffset", 0);
      d3.selectAll("#stockline_axis_label,#stockline_axis")
        .style("opacity", "0")
        .transition("drawStockLine")
        .delay(2500)
        .duration(500)
        .style("opacity", "1");
      state = 1;
    }

    d3.selectAll(".line").style("stroke-width", 3);
}

function reset() { 
  state = null;
  animatelines();
}
function next() { animatelines(); }
</script>
</body>
